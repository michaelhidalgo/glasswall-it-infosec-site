<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.68">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-165717322-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-165717322-1",{})</script><title data-react-helmet="true">SQL Injection | Glasswall Infosec and IT</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="SQL Injection | Glasswall Infosec and IT"><meta data-react-helmet="true" name="description" content="This notebook takes you through some of the techniques used to take advantage of SQLI vulnerabilities. You can either review the code blocks and their outputs, or you can follow along by running each code block. You will need access to SQL Server that has the OLTP DB WideWorldImporters which can be download for free from Microsoft."><meta data-react-helmet="true" property="og:description" content="This notebook takes you through some of the techniques used to take advantage of SQLI vulnerabilities. You can either review the code blocks and their outputs, or you can follow along by running each code block. You will need access to SQL Server that has the OLTP DB WideWorldImporters which can be download for free from Microsoft."><meta data-react-helmet="true" property="og:url" content="http://it-infosec.glasswallsolutions.com//docs/security_awareness/owasp/sqli"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://it-infosec.glasswallsolutions.com//docs/security_awareness/owasp/sqli"><link rel="stylesheet" href="/styles.52b8d211.css">
<link rel="preload" href="/styles.1537640d.js" as="script">
<link rel="preload" href="/runtime~main.8e1c8b67.js" as="script">
<link rel="preload" href="/main.c66f3f60.js" as="script">
<link rel="preload" href="/1.aff1b80e.js" as="script">
<link rel="preload" href="/47.2e8c9fd1.js" as="script">
<link rel="preload" href="/48.6031022e.js" as="script">
<link rel="preload" href="/935f2afb.3aec4b55.js" as="script">
<link rel="preload" href="/46.703b8c0b.js" as="script">
<link rel="preload" href="/35017275.1cd3f08c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/glasswall_logo_blue.png" alt="Glasswall Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img alt="Glasswall Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Glasswall IT and Infosec</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/AboutUs/InfosecTeam/TheTeam">Documentation</a><a href="https://medium.com/glasswall-engineering/tagged/infosecit" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/filetrust" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/glasswall_logo_blue.png" alt="Glasswall Logo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img alt="Glasswall Logo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Glasswall IT and Infosec</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/AboutUs/InfosecTeam/TheTeam">Documentation</a></li><li class="menu__list-item"><a href="https://medium.com/glasswall-engineering/tagged/infosecit" target="_blank" rel="noopener noreferrer" class="menu__link">Blog</a></li><li class="menu__list-item"><a href="https://github.com/filetrust" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">About Us</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">IT Team</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/AboutUs/ItTeam/TheTeam">The Team</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">InfoSec Team</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/AboutUs/InfoSecTeam/TheTeam">The Team</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Careers</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/careers/rules-of-engagement">Rules of Engagement</a></li><li class="menu__list-item"><a href="http://careers.glasswallsolutions.com/" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Work for Glasswall</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">IT Team</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Projects</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/Projects/ItTeam/OfficeLiberationProject">Office liberation project</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">InfoSec Team</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Projects</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/Projects/InfoSecTeam/IncidentManagement">Incident Management</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Security Awareness</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">C#</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/ldap_injection">LDAP Injection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/command_injection">Command Injection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/xpath_injection">Xpath Injection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/hardcoded_keys">Hard-coded Keys</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/insecure_randomness">Insecure Randomness</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/open_redirect">Open Redirect</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/xss">Cross-site Scripting (XSS)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/sqli">SQL Injection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Csharp/EmptyTryCatch">Empty Try-Catch Block</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">C</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/C/BufferOverflow">Buffer Overflow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/C/uaf">Use After Free (UAF) Vulnerability</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/C/MemoryLeak">Memory Leak Vulnerability</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/C/DoubleFree">Double-Free Vulnerability</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/C/IntegerOverflow">Integer Overflow or Wraparound Vulnerability</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/C/OutOfBounds">Out Of Bounds</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Python</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Python/InjectionAttacks">Injection Attacks</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Python/DynamicCodeExecution">Dynamic Code Execution</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Python/RequestRedirect">Request Redirect</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Python/Deserialization">Deserialization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Python/WeakEncryption">Weak Encryption</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/security_awareness/languages/Python/XXE">XML External Entities (XXE)</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!" tabindex="0">OWASP Top 10</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/security_awareness/owasp/sqli">SQL Injection</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">SQL Injection</h1></header><div class="markdown"><p>This notebook takes you through some of the techniques used to take advantage of SQLI vulnerabilities. You can either review the code blocks and their outputs, or you can follow along by running each code block. You will need access to SQL Server that has the OLTP DB WideWorldImporters which can be download for free from <a href="https://docs.microsoft.com/en-us/sql/samples/wide-world-importers-oltp-install-configure?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">Microsoft.</a></p><p>Some definitions of SQLi, taken from a number of different sources. </p><ul><li>SQL injection is a code injection technique that might destroy your database.</li><li>SQL injection is one of the most common web hacking techniques.</li><li>SQL injection is the placement of malicious code in SQL statements, via web page input. <br><a href="https://www.w3schools.com/sql/sql_injection.asp" target="_blank" rel="noopener noreferrer">Reference</a> <br></li></ul><p>It is currently the <a href="https://appcheck-ng.com/appcheck-vs-owasp-top-10/?gclid=Cj0KCQjwtsv7BRCmARIsANu-CQdJq-3ASHZFM59JI9RxhvRA0stiRwlGaPrpWKtJNXfb4FmrqLIFJuoaAn6IEALw_wcB" target="_blank" rel="noopener noreferrer">OWASP</a> No.1 vulnerability</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="example-1---basic-select"></a>Example 1 - Basic Select<a aria-hidden="true" class="hash-link" href="#example-1---basic-select" title="Direct link to heading">#</a></h2><p>The below code looks like a very simple dynamic query which accepts a users name as an input. You could imagine a login screen that you enter you user name into before you login. </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserId NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@SQL NVARCHAR(1000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserId = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @SQL = &#x27;SELECT * </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FROM Application.People AS P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            WHERE P.PersonId = &#x27; + @UserId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRINT @SQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC(@SQL)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Now what happens if you change the input slightly.</p><p>You can now see that the original logic of the query is no longer intact.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserId NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@SQL NVARCHAR(1000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserId = &#x27;2 OR 1 = 1;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @SQL = &#x27;SELECT * </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FROM Application.People AS P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            WHERE P.FullName = &#x27; + @UserId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRINT @SQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC(@SQL)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="example-2---username-and-password"></a>Example 2 - UserName and Password<a aria-hidden="true" class="hash-link" href="#example-2---username-and-password" title="Direct link to heading">#</a></h2><p>Now lets look at a more realistic example, you have a user name and password fields in a login window.</p><p>A quick change to the user name passed in &#x27;&#x27;&#x27;Lily Code&#x27;&#x27;--&#x27; and when you view the SQL Statement below you will see that the password section has been codded out. </p><p>In SQL Server the following commands can be used to comment out lines of sections of code. <br>
-- This will comment out everything to the right <br>
/<em> everything between these two points, marked with a slash and asterisk  will be commented out </em>/</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserName NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@Password NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@SQL NVARCHAR(1000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;&#x27;&#x27;Lily Code&#x27;&#x27;--&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @Password = &#x27;&#x27;&#x27;Doesnt matter&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @SQL = &#x27;SELECT * </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FROM Application.People AS P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            WHERE P.FullName = &#x27; + @UserName + &#x27; AND P.Password = &#x27; + @Password</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRINT @SQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC(@SQL)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SELECT * FROM Application.People AS P WHERE P.FullName = &#x27;Lily Code&#x27;-- AND P.Password = &#x27;Doesnt matter&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="example-3---selecting-additional-data"></a>Example 3 - Selecting additional data<a aria-hidden="true" class="hash-link" href="#example-3---selecting-additional-data" title="Direct link to heading">#</a></h2><p>Now this is where an experienced hacker can really start to attack your SQL Server, or worse start changing things without you knowing, bank account details, extracting card details etc.</p><p>In the below example as well as copying out the password section the hacker has inserted the following code &quot;SELECT * FROM sys.tables&quot;. This is a system table, which as you can see lists out all the tables in the current database.</p><p>Now think about what would happen if a hacker had access to your database, what information would they take, or should they just run DROP DATABASE.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserName NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@Password NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@SQL NVARCHAR(1000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;&#x27;&#x27;Lily Code&#x27;&#x27;SELECT * FROM sys.tables AS T INNER JOIN sys.schemas AS S ON T.Schema_Id = S.Schema_Id;--&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @Password = &#x27;&#x27;&#x27;Doesnt matter&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @SQL = &#x27;SELECT * </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FROM Application.People AS P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            WHERE P.FullName = &#x27; + @UserName + &#x27; AND P.Password = &#x27; + @Password</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRINT @SQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC(@SQL)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>You can even use the same method to find out the version of SQL Server that is being used.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserName NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@Password NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@SQL NVARCHAR(1000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;&#x27;&#x27;Lily Code&#x27;&#x27; SELECT @@Version AS SqlServerVersion; SELECT * FROM Sales.Customers;--&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @Password = &#x27;&#x27;&#x27;Doesnt matter&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @SQL = &#x27;SELECT * </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FROM Application.People AS P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            WHERE P.FullName = &#x27; + @UserName + &#x27; AND P.Password = &#x27; + @Password</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRINT @SQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC(@SQL)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="example-4---dropping-objects"></a>Example 4 - Dropping Objects<a aria-hidden="true" class="hash-link" href="#example-4---dropping-objects" title="Direct link to heading">#</a></h2><p>The exploits of the hacker so far have been focused on phishing style attacks, trying to retrieve data. It is however possible to cause a denial of service style attack by dropping tables or changing data. This could then make it impossible for the application to function or users to login.</p><p>The first script below will setup a new customer table [Sales].[Customers_SQLI_Example] which is just for testing the following command.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DROP TABLE IF EXISTS [Sales].[Customers_SQLI_Example]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE [Sales].[Customers_SQLI_Example](</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [CustomerID] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [CustomerName] [nvarchar](100) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [BillToCustomerID] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [CustomerCategoryID] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [BuyingGroupID] [int] NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [PrimaryContactPersonID] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [AlternateContactPersonID] [int] NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [DeliveryMethodID] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [DeliveryCityID] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [PostalCityID] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [CreditLimit] [decimal](18, 2) NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [AccountOpenedDate] [date] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [StandardDiscountPercentage] [decimal](18, 3) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [IsStatementSent] [bit] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [IsOnCreditHold] [bit] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [PaymentDays] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [PhoneNumber] [nvarchar](20) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [FaxNumber] [nvarchar](20) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [DeliveryRun] [nvarchar](5) NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [RunPosition] [nvarchar](5) NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [WebsiteURL] [nvarchar](256) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [DeliveryAddressLine1] [nvarchar](60) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [DeliveryAddressLine2] [nvarchar](60) NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [DeliveryPostalCode] [nvarchar](10) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [DeliveryLocation] [geography] NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [PostalAddressLine1] [nvarchar](60) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [PostalAddressLine2] [nvarchar](60) NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [PostalPostalCode] [nvarchar](10) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [LastEditedBy] [int] NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [ValidFrom] [datetime2](7) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [ValidTo] [datetime2](7) NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> CONSTRAINT [PK_Sales_Customers_SQLI_Example] PRIMARY KEY CLUSTERED </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [CustomerID] ASC</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [USERDATA],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> CONSTRAINT [UQ_Sales_Customers_SQLI_Example_CustomerName] UNIQUE NONCLUSTERED </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [CustomerName] ASC</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [USERDATA]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) ON [USERDATA] TEXTIMAGE_ON [USERDATA]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INSERT [Sales].[Customers_SQLI_Example] ([CustomerID], [CustomerName], [BillToCustomerID], [CustomerCategoryID], [BuyingGroupID], [PrimaryContactPersonID], [AlternateContactPersonID], [DeliveryMethodID], [DeliveryCityID], [PostalCityID], [CreditLimit], [AccountOpenedDate], [StandardDiscountPercentage], [IsStatementSent], [IsOnCreditHold], [PaymentDays], [PhoneNumber], [FaxNumber], [DeliveryRun], [RunPosition], [WebsiteURL], [DeliveryAddressLine1], [DeliveryAddressLine2], [DeliveryPostalCode], [DeliveryLocation], [PostalAddressLine1], [PostalAddressLine2], [PostalPostalCode], [LastEditedBy], [ValidFrom], [ValidTo]) VALUES (1, N&#x27;Tailspin Toys (Head Office)&#x27;, 1, 7, 2, 47, 48, 7, 6863, 6863, CAST(3600.00 AS Decimal(18, 2)), CAST(N&#x27;2013-01-01&#x27; AS Date), CAST(0.000 AS Decimal(18, 3)), 0, 0, 30, N&#x27;(612) 555-2458&#x27;, N&#x27;(612) 555-1723&#x27;, N&#x27;&#x27;, N&#x27;&#x27;, N&#x27;http://www.tailspintoys.com/&#x27;, N&#x27;8408 Sycamore Trail&#x27;, N&#x27;8408 Sycamore Trail&#x27;, N&#x27;57143&#x27;, 0xE6100000010C47A00B34E9BA4640914F7E41C11B58C0, N&#x27;547 Eighth Alley&#x27;, N&#x27;&#x27;, N&#x27;28949&#x27;, 1, CAST(N&#x27;2013-01-01T00:00:00.0000000&#x27; AS DateTime2), CAST(N&#x27;9999-12-31T23:59:59.9999999&#x27; AS DateTime2))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">INSERT [Sales].[Customers_SQLI_Example] ([CustomerID], [CustomerName], [BillToCustomerID], [CustomerCategoryID], [BuyingGroupID], [PrimaryContactPersonID], [AlternateContactPersonID], [DeliveryMethodID], [DeliveryCityID], [PostalCityID], [CreditLimit], [AccountOpenedDate], [StandardDiscountPercentage], [IsStatementSent], [IsOnCreditHold], [PaymentDays], [PhoneNumber], [FaxNumber], [DeliveryRun], [RunPosition], [WebsiteURL], [DeliveryAddressLine1], [DeliveryAddressLine2], [DeliveryPostalCode], [DeliveryLocation], [PostalAddressLine1], [PostalAddressLine2], [PostalPostalCode], [LastEditedBy], [ValidFrom], [ValidTo]) VALUES (2, N&#x27;Tailspin Toys (DeKalb, IL)&#x27;, 1, 3, 2, 49, 47, 2, 8758, 8758, CAST(3500.00 AS Decimal(18, 2)), CAST(N&#x27;2013-01-01&#x27; AS Date), CAST(0.000 AS Decimal(18, 3)), 0, 0, 30, N&#x27;(217) 555-1687&#x27;, N&#x27;(217) 555-9570&#x27;, N&#x27;&#x27;, N&#x27;&#x27;, N&#x27;http://www.tailspintoys.com/&#x27;, N&#x27;531 9th Way&#x27;, N&#x27;531 9th Way&#x27;, N&#x27;72436&#x27;, 0xE6100000010C693FADFDF8F64440AAA4A9F9053056C0, N&#x27;2218 Walnut Highway&#x27;, N&#x27;&#x27;, N&#x27;76090&#x27;, 1, CAST(N&#x27;2013-01-01T00:00:00.0000000&#x27; AS DateTime2), CAST(N&#x27;9999-12-31T23:59:59.9999999&#x27; AS DateTime2))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SELECT * FROM Sales.Customers_SQLI_Example</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>You can see that the stored procedure has been created and two records have been inserted. Running the below code will now DROP this newly created table.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserName NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@Password NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@SQL NVARCHAR(1000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;&#x27;&#x27;Lily Code&#x27;&#x27; DROP TABLE IF EXISTS Sales.Customers_SQLI_Example;--&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @Password = &#x27;&#x27;&#x27;Doesnt matter&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @SQL = &#x27;SELECT * </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FROM Application.People AS P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            WHERE P.FullName = &#x27; + @UserName + &#x27; AND P.PersonID = &#x27; + @Password</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRINT @SQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC(@SQL)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SELECT * FROM Sales.Customers_SQLI_Example</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="best-practice"></a>Best Practice<a aria-hidden="true" class="hash-link" href="#best-practice" title="Direct link to heading">#</a></h2><p>There are a few different ways you can execute a command against a SQL database. One such example is by using Stored Procedures.</p><p>The example below if a very basic stored procedure which returns whether or not the user has entered a correct username and password.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DROP PROCEDURE IF EXISTS Application.CheckLogin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROCEDURE Application.CheckLogin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @ProvidedUserName NVARCHAR(50)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@ProvidedPassword NVARCHAR(20)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">AS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    DECLARE @IsPermittedToLogon NVARCHAR(10)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT  @IsPermittedToLogon = P.IsPermittedToLogon</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM    Application.People AS P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE   P.FullName = @ProvidedUserName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AND     P.HashedPassword IS NOT NULL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT @IsPermittedToLogon AS IsPermittedToLogon</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Use the SQL below to execute the stored procedure, it will return a 1 if the user credentials are correct.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserName NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@Password NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;Lily Code&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @Password = &#x27;0xCDF7EE2DB6B94C9BCF2D003E37354081BCD53D7B983F1412729D3BC1E4F89876&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC Application.CheckLogin @ProvidedUserName = @UserName, @ProvidedPassword = @Password</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Now lets try one of the SQLi techniques used above to comment out the password.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserName NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@Password NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;&#x27;&#x27;Lily Code&#x27;&#x27;--&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @Password = &#x27;Do not know&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC Application.CheckLogin @ProvidedUserName = @UserName, @ProvidedPassword = @Password</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;&#x27;&#x27;Lily Code&#x27;&#x27; SELECT @@Version AS SqlServerVersion; SELECT * FROM Sales.Customers;--&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC Application.CheckLogin @ProvidedUserName = @UserName, @ProvidedPassword = @Password</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>You will have noticed that the password field was not ignored, this is because each parameters it used individual and not used to build a dynamic SQL query.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="stored-procedures-are-not-always-free-of-vulnerabilities"></a>Stored Procedures are not always free of vulnerabilities<a aria-hidden="true" class="hash-link" href="#stored-procedures-are-not-always-free-of-vulnerabilities" title="Direct link to heading">#</a></h2><p>This is an extract from an existing stored procedure which has potential vulnerabilities. This is because it is using dynamic T-SQL statements within the stored procedure.</p><p>In the below example mitigating steps have been include to reduce the risk of a SQLi attack. The passed in variables are being used to build dynamic sql, which ideally should be avoided, but sometimes there is no other logical option. In this case the @Company variable is being checked and known malicious commands are removed. </p><p>DO NOT TRY AND RUN THE BELOW</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- This code should not be executed</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PROCEDURE NAME PROCEDURE [temp].[usp_SelectT]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @Company        NVARCHAR(100)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@FromDate      DATETIME2(7)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@ToDate        DATETIME2(7)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@EmailFrom     EmailFrom       READONLY    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@EmailTo       EmailTo         READONLY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@Trans         Trans           READONLY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@FileName      FileNames       READONLY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@FileOutCome   FileOutcome     READONLY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@EmailSubject  EmailSubject    READONLY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@BatchSize     INT = 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@PageNumber    INT = 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@OrderBy       INT = 2 -- 1 = Status, 2 = Event Time, 3 = From, 4 = To, 5= Subject, 6 = File Count</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ,@OrderByDir    INT = 2 -- 1 = ASC, 2 = DESC</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">AS</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -- Added to deal with SQL Injection for this variable.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT @Company = REPLACE(@Company, &#x27;--&#x27;,&#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT @Company = REPLACE(@Company, &#x27;WAITFOR&#x27;,&#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT @Company = REPLACE(@Company, &#x27;=&#x27;,&#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT @Company = REPLACE(@Company, &#x27;;&#x27;,&#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT @Company = REPLACE(@Company, &#x27;/*&#x27;,&#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT @Company = REPLACE(@Company, &#x27;*/&#x27;,&#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT @Company = REPLACE(@Company, &#x27;)&#x27;,&#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    DECLARE @Sql VARCHAR(MAX)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ,@Offset INT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SET @Offset = (@PageNumber -1) * @BatchSize </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SET @Sql = &#x27; &#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SET @Sql = @Sql + &#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        SELECT  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ET.TId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ,STRING_AGG ( ISNULL(ET.EmailTo,&#x27;&#x27;N/A&#x27;&#x27;), &#x27;&#x27;;&#x27;&#x27;) AS EmailTo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                INTO #EmailToAgg</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        FROM        dbo.EmailTable      AS ET&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IF ((SELECT COUNT(*) FROM @EmailTo) &gt; 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        SELECT * INTO #EmailTo FROM @EmailTo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        SET @Sql = @Sql + &#x27; INNER JOIN  #EmailTo AS E   ON ET.EmailTo   = E.EmailAddress &#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    END</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SET @Sql = @Sql + &#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        WHERE   ET.CompanyId = &#x27;&#x27;&#x27; + @Company + &#x27;&#x27;&#x27; &#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IF ((SELECT COUNT(*) FROM @Transaction) &gt; 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        SELECT * INTO #Trans FROM @Trans</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        SET @Sql = @Sql + &#x27; AND ET.SId IN (SELECT TId FROM #Trans)&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    END</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SET @Sql = @Sql + &#x27; GROUP BY ET.TId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        OPTION  (RECOMPILE)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        &#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SET @Sql = @Sql +  &#x27; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                -- Required for the main Transaction Page or for one of the filters. Could use a different one</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                RR.Id </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ,RR.Company</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ,RR.Date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ,RR.[From] </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ,ET.EmailTo     </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                ,RR.SubjectTruncated </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                INTO #StagingResults</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM        dbo.ReceiverR       AS RR </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    INNER JOIN  #EmailToAgg                 AS ET   ON SR.Id = ET.TSId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE   RR.Company = &#x27;&#x27;&#x27; + @Tenant + &#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    AND     RR.Date &gt;= &#x27;&#x27;&#x27; + CAST(@FromDate AS VARCHAR) + &#x27;&#x27;&#x27; AND RR.Date &lt;= &#x27;&#x27;&#x27; + CAST(@ToDate AS VARCHAR) + &#x27;&#x27;&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="database-permissions"></a>Database Permissions<a aria-hidden="true" class="hash-link" href="#database-permissions" title="Direct link to heading">#</a></h2><p>It is also very important to restrict the access permissions of the user that the application is using the execute the code. Several of the statements I have used above for retrieving data and altering the DB would not be possible if the correct user had been granted the required permissions.</p><p>The below may need to be run in SQL Server Management Studio.</p><p>If you are using a new install of SQL Server then by default SQL Logins will be disabled. </p><p>Steps to enable</p><ol><li>Open SSMS and connect with AD user</li><li>Right click on the server and go to Security</li><li>Change the Server Authentication to &quot;SQL Server and Windows Authentication mode&quot;</li><li>Re-start the SQL Server service</li></ol><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">USE WideWorldImporters</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DROP USER IF EXISTS TestAccount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">USE MASTER</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DROP USER IF EXISTS TestAccount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">IF EXISTS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            SELECT  1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FROM    sys.sql_logins AS L</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            WHERE   l.name = &#x27;TestAccount&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    DROP LOGIN TestAccount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Code to create the new used and assign required permissions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE LOGIN TestAccount  WITH PASSWORD = &#x27;ThisIsNotAGoodPasswordToUse123&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE USER TestAccount FROM LOGIN TestAccount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GRANT CONNECT SQL TO TestAccount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">USE WideWorldImporters</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE USER TestAccount FROM LOGIN TestAccount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GRANT EXECUTE ON Application.CheckLogin TO TestAccount </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Now change the connection to login using the new user. This process should be run using Azure Data Studio notebooks. This is to test that the created user is able to execute the stored procedure, but even if SQLi is possible, the user can not select directly from any of the tables. </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">USE WideWorldImporters</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserName NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@Password NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;Lily Code&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @Password = &#x27;0xCDF7EE2DB6B94C9BCF2D003E37354081BCD53D7B983F1412729D3BC1E4F89876&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC Application.CheckLogin @ProvidedUserName = @UserName, @ProvidedPassword = @Password</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>You can see from the above that user has permissions to run the stored procedure.</p><p>Now run the below which is one of the SQLi statements we run above, it should return no data because the user does not have permissions to select from that table.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DECLARE @UserName NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@Password NVARCHAR(255)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ,@SQL NVARCHAR(1000)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @UserName = &#x27;&#x27;&#x27;Lily Code&#x27;&#x27;SELECT * FROM sys.tables AS T INNER JOIN sys.schemas AS S ON T.Schema_Id = S.Schema_Id;--&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @Password = &#x27;&#x27;&#x27;Doesnt matter&#x27;&#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SET @SQL = &#x27;SELECT * </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FROM Application.People AS P</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            WHERE P.FullName = &#x27; + @UserName + &#x27; AND P.PersonID = &#x27; + @Password</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">PRINT @SQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXEC(@SQL)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/security_awareness/languages/Python/XXE"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« XML External Entities (XXE)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#example-1---basic-select" class="table-of-contents__link">Example 1 - Basic Select</a></li><li><a href="#example-2---username-and-password" class="table-of-contents__link">Example 2 - UserName and Password</a></li><li><a href="#example-3---selecting-additional-data" class="table-of-contents__link">Example 3 - Selecting additional data</a></li><li><a href="#example-4---dropping-objects" class="table-of-contents__link">Example 4 - Dropping Objects</a></li><li><a href="#best-practice" class="table-of-contents__link">Best Practice</a></li><li><a href="#stored-procedures-are-not-always-free-of-vulnerabilities" class="table-of-contents__link">Stored Procedures are not always free of vulnerabilities</a></li><li><a href="#database-permissions" class="table-of-contents__link">Database Permissions</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/products/rebuild-api/quickstart-rebuild">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/glasswall" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/filetrust" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li><li class="footer__item"><a href="https://twitter.com/glasswallglobal" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://www.linkedin.com/company/glasswall-solutions-limited/" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2020 Glasswall Solutions Ltd. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.1537640d.js"></script>
<script src="/runtime~main.8e1c8b67.js"></script>
<script src="/main.c66f3f60.js"></script>
<script src="/1.aff1b80e.js"></script>
<script src="/47.2e8c9fd1.js"></script>
<script src="/48.6031022e.js"></script>
<script src="/935f2afb.3aec4b55.js"></script>
<script src="/46.703b8c0b.js"></script>
<script src="/35017275.1cd3f08c.js"></script>
</body>
</html>